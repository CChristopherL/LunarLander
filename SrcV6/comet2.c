#include "comet2.h"
#include "renderer.h"
#include "debris.h"
#include "noise.h"

void initComet2(comet2_t *comet, vector_t position, vector_t velocity) {
	static const uint16_t cometImage[11][128] = {
		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032, //1
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032, //2
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //3
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //4
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //5
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x38B0,0x38B0,0x38B0,0x38B0,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032, //6
		0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032, //7
		0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //8
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //9
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //10
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x0032,
		0x0032,0x0032,0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,
		0x0032,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,
		0x38B0,0x38B0,0x38B0,0x38B0,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B2,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,
		0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x38B0,0x0032,0x0032,0x0032,0x0032},

		{0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032, //11
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,
		0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032,0x0032}
		};
	static const vector_t cometImageSize = {16, 8};

	comet->image = cometImage;
	comet->imageSize = cometImageSize;

	comet->position = position;
	comet->velocity = velocity;
	comet->frame = 0;
	comet->broken = 0;
}

void breakComet2(comet2_t *comet) {
	comet->broken = 1;

	// Initialize the debris
	vector_t debris1Position = {comet->position.x, comet->position.y};
	vector_t debris1Velocity = {300, -300};
	initDebris(&(comet->debris1), debris1Position, debris1Velocity, 0);

	vector_t debris2Position = {comet->position.x, comet->position.y + 3};
	vector_t debris2Velocity = {200, 100};
	initDebris(&(comet->debris2), debris2Position, debris2Velocity, 1);

	vector_t debris3Position = {comet->position.x + 6, comet->position.y + 3};
	vector_t debris3Velocity = {-300, -200};
	initDebris(&(comet->debris3), debris3Position, debris3Velocity, 2);
}

static void updatePhysics(comet2_t *comet, uint32_t deltaTime) {
	// Apply gravity
	//comet->velocity.y += deltaTime;

	// Apply velocity
	comet->position.x += comet->velocity.x * deltaTime;
	comet->position.y += comet->velocity.y * deltaTime;

	// Wrap x position
	comet->position.x = (comet->position.x < 0) ? (comet->position.x & 262143) - 1 : (comet->position.x & 262143);
}

static void checkCollisions(comet2_t *comet, uint32_t deltaTime) {
	vector_t collisionPosition = convertToDisplayPosition(comet->position);
	collisionPosition.y += comet->imageSize.y - 1;
	collisionPosition.x += (comet->imageSize.x >> 1);
	if ((comet->broken == 0) && (collisionPosition.y > getTerrainHeight(collisionPosition))) {
		breakComet2(comet);
	}
}

void updateComet2(comet2_t *comet, uint32_t deltaTime) {
	updatePhysics(comet, deltaTime);

	// Apply animation
	if (comet->broken == 0) {
		comet->frame += (deltaTime << 1);
		if ((comet->frame >> 4) > 9) {
			comet->frame = 0;
		}
	}

	checkCollisions(comet, deltaTime);

	vector_t displayPosition = {(comet->position.x >> 10), (comet->position.y >> 10)};

	// Draw the debris
	if (comet->broken == 1) {

		// Erase the comet
		if ((comet->frame >> 4) < 10) {
			comet->frame = (10 << 4);
			addToBuffer(comet->image[10], displayPosition, comet->imageSize);
		}

		updateDebris(&(comet->debris1), deltaTime);
		updateDebris(&(comet->debris2), deltaTime);
		updateDebris(&(comet->debris3), deltaTime);
	} else {

		// Send the comet to buffer
		addToBuffer(comet->image[(comet->frame) >> 4], displayPosition, comet->imageSize);
	}
}
